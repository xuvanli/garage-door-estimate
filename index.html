<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Garage Door Estimate (No-Build)</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel Standalone to transpile JSX in-browser (ok for quick deploy) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    const currency = (value) => {
      const numeric = Number.isFinite(value) ? value : Number(value);
      const amount = Number.isFinite(numeric) ? numeric : 0;
      return amount.toLocaleString(undefined, { style: "currency", currency: "USD" });
    };

    const pct = (n) => `${(n * 100).toFixed(2)}%`;
    const id = () => Math.random().toString(36).slice(2);

    const DEFAULT_PRESETS = {
      laborRatePerHour: 145,
      tripFee: 59,
      taxRate: 0.101,
      minLaborHours: 1,
      parts: {
        torsionSpring: 289,
        extensionSpring: 189,
        cable: 129,
        roller: 19,
        hinge: 14,
        bearing: 39,
        drum: 69,
        strut8ft: 119,
        strut16ft: 179,
        sensorPair: 119,
        openerBeltChain: 139,
        openerCapacitor: 79,
        keypad: 89,
        remote: 59,
        weatherSeal: 6.5,
        bottomRubber: 9.5,
        panelRepair: 249,
        panelReplace: 489,
      },
    };

    function usePWA() {
      const [installed, setInstalled] = useState(false);
      const deferredPromptRef = useRef(null);

      useEffect(() => {
        const manifest = {
          name: "Garage Door Estimate",
          short_name: "GD Estimate",
          start_url: ".",
          display: "standalone",
          background_color: "#0b1f24",
          theme_color: "#0ea5e9",
          icons: [{
            src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='48' fill='%230ea5e9'/%3E%3Cpath d='M48 92h160v92H48z' fill='%23fff'/%3E%3Crect x='64' y='72' width='128' height='20' rx='4' fill='%23fff'/%3E%3Cpath d='M64 92v92m128-92v92M96 124h32v32H96zm64 0h-32v32h32z' stroke='%230b1f24' stroke-width='8' fill='none'/%3E%3C/svg%3E",
            sizes: "256x256",
            type: "image/svg+xml",
            purpose: "any",
          }],
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = url;
        document.head.appendChild(link);

        const swCode = `
          const CACHE = 'gd-estimate-v1';
          const ASSETS = ['/', self.location.href];
          self.addEventListener('install', (e)=>{
            e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)));
            self.skipWaiting();
          });
          self.addEventListener('activate', (e)=>{
            e.waitUntil(
              caches.keys().then(keys=>Promise.all(keys.map(k=>k===CACHE?null:caches.delete(k))))
            );
            self.clients.claim();
          });
          self.addEventListener('fetch', (e)=>{
            e.respondWith(
              caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
                const copy = res.clone();
                caches.open(CACHE).then(c=>c.put(e.request, copy));
                return res;
              }).catch(()=> caches.match('/')))
            );
          });
        `;
        const swBlob = new Blob([swCode], { type: "text/javascript" });
        const swUrl = URL.createObjectURL(swBlob);
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register(swUrl).catch(() => {});
        }

        const onBeforeInstall = (e) => { e.preventDefault(); deferredPromptRef.current = e; };
        const onAppInstalled = () => setInstalled(true);
        window.addEventListener("beforeinstallprompt", onBeforeInstall);
        window.addEventListener("appinstalled", onAppInstalled);
        return () => {
          window.removeEventListener("beforeinstallprompt", onBeforeInstall);
          window.removeEventListener("appinstalled", onAppInstalled);
          document.head.removeChild(link);
          URL.revokeObjectURL(url);
        };
      }, []);

      const requestInstall = async () => {
        const p = deferredPromptRef.current;
        if (!p) return;
        p.prompt();
        await p.userChoice;
      };

      return { installed, requestInstall };
    }

    function useLocalState(key, initial) {
      const [state, setState] = useState(() => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : initial;
        } catch { return initial; }
      });
      useEffect(() => {
        try { localStorage.setItem(key, JSON.stringify(state)); } catch {}
      }, [key, state]);
      return [state, setState];
    }

    function Card({ title, children, className = "", ...props }) {
      return (
        <div className={`bg-white rounded-2xl shadow-sm border border-slate-200 p-4 ${className}`} {...props}>
          <div className="font-semibold mb-2">{title}</div>
          {children}
        </div>
      );
    }
    function Field({ label, value, onChange }) {
      return (
        <label className="block mb-2">
          <div className="text-xs text-slate-500 mb-1">{label}</div>
          <input className="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-sky-300" value={value} onChange={(e) => onChange(e.target.value)} />
        </label>
      );
    }
    function NumberField({ label, value, onChange, min, max, step }) {
      return (
        <label className="block mb-2">
          <div className="text-xs text-slate-500 mb-1">{label}</div>
          <input type="number" className="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-sky-300" value={value} min={min} max={max} step={step} onChange={(e) => onChange(Number(e.target.value))} />
        </label>
      );
    }
    function TextArea({ label, value, onChange, rows=3 }) {
      return (
        <label className="block mb-2">
          <div className="text-xs text-slate-500 mb-1">{label}</div>
          <textarea className="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-sky-300" rows={rows} value={value} onChange={(e) => onChange(e.target.value)} />
        </label>
      );
    }
    function Toggle({ label, checked, onChange }) {
      return (
        <label className="flex items-center gap-2 mb-2">
          <input type="checkbox" checked={checked} onChange={(e) => onChange(e.target.checked)} />
          <span className="text-sm">{label}</span>
        </label>
      );
    }
    function Row({ label, value }) {
      return (
        <div className="grid grid-cols-2 gap-2">
          <div className="text-slate-500">{label}</div>
          <div className="text-right">{value}</div>
        </div>
      );
    }

    function App() {
      const { requestInstall } = usePWA();

      const [presets, setPresets] = useLocalState("gd.presets", DEFAULT_PRESETS);
      const [customer, setCustomer] = useLocalState("gd.customer", {
        name: "", phone: "", email: "", address: "", city: "Seattle, WA",
        notes: "", coupon: 0,
      });
      const [labor, setLabor] = useLocalState("gd.labor", { hours: 1 });
      const [items, setItems] = useLocalState("gd.items", [
        { id: id(), name: "Trip Fee", qty: 1, unit: 1, price: presets.tripFee, taxable: true, group: "Services", travel: true },
      ]);

      React.useEffect(() => {
        setItems((prev) =>
          prev.map((it) => {
            if (it.travel) {
              return { ...it, price: presets.tripFee };
            }

            if (it.name === "Trip Fee") {
              return { ...it, price: presets.tripFee, travel: true, group: it.group || "Services" };
            }

            return it;
          })
        );
      }, [presets.tripFee]);

      const addItem = (patch = {}, options = {}) => {
        const baseItem = {
          id: id(),
          name: "Custom",
          qty: 1,
          unit: 1,
          price: 0,
          taxable: true,
          group: "Parts",
          travel: false,
          ...patch,
        };
        const shouldMerge = options.merge === true && baseItem.name;

        setItems((prev) => {
          if (!shouldMerge) {
            return [...prev, baseItem];
          }

          const existingIndex = prev.findIndex((item) =>
            item.name.toLowerCase() === baseItem.name.toLowerCase() &&
            (item.group || "Parts") === (baseItem.group || "Parts") &&
            Number(item.price) === Number(baseItem.price) &&
            Number(item.unit) === Number(baseItem.unit) &&
            (item.taxable ?? true) === (baseItem.taxable ?? true) &&
            Boolean(item.travel) === Boolean(baseItem.travel)
          );

          if (existingIndex === -1) {
            return [...prev, baseItem];
          }

          const updated = [...prev];
          const existing = updated[existingIndex];
          updated[existingIndex] = { ...existing, qty: existing.qty + baseItem.qty };
          return updated;
        });
      };
      const removeItem = (idToRemove) => setItems((prev) => prev.filter((i) => i.id !== idToRemove));

      const subtotal = useMemo(() => items.reduce((s, i) => s + i.qty * i.unit * i.price, 0), [items]);
      const laborHours = useMemo(() => {
        const value = Number(labor.hours);
        return Number.isFinite(value) && value >= 0 ? value : 0;
      }, [labor.hours]);
      const laborCost = useMemo(
        () => Math.max(laborHours, presets.minLaborHours) * presets.laborRatePerHour,
        [laborHours, presets.minLaborHours, presets.laborRatePerHour]
      );
      const discount = useMemo(() => Math.max(0, Number(customer.coupon) || 0), [customer.coupon]);

      const [taxableItemsTotal, taxableTravelTotal] = useMemo(() => {
        return items.reduce(
          (acc, item) => {
            if (!item.taxable) {
              return acc;
            }

            const lineTotal = item.qty * item.unit * item.price;
            if (item.travel) {
              acc[1] += lineTotal;
            } else {
              acc[0] += lineTotal;
            }

            return acc;
          },
          [0, 0]
        );
      }, [items]);

      const taxableBase = useMemo(() => {
        const taxItems = taxableItemsTotal;
        const taxTravel = taxableTravelTotal;
        const taxLabor = laborCost;
        return taxItems + taxLabor + taxTravel;
      }, [laborCost, taxableItemsTotal, taxableTravelTotal]);

      const tax = useMemo(() => taxableBase * presets.taxRate, [taxableBase, presets.taxRate]);
      const total = useMemo(() => Math.max(0, subtotal + laborCost + tax - discount), [subtotal, laborCost, tax, discount]);

      const PRESET_PART_LABELS = {
        torsionSpring: "Torsion Spring",
        extensionSpring: "Extension Spring",
        cable: "Lift Cable (per side)",
        roller: "Nylon Roller",
        hinge: "Hinge",
        bearing: "Center/End Bearing",
        drum: "Cable Drum",
        strut8ft: "Reinforcement Strut 8'",
        strut16ft: "Reinforcement Strut 16'",
        sensorPair: "Safety Sensors (pair)",
        openerBeltChain: "Opener Belt/Chain",
        openerCapacitor: "Opener Capacitor",
        keypad: "Wireless Keypad",
        remote: "Remote Control",
        weatherSeal: "Perimeter Weather Seal (ft)",
        bottomRubber: "Bottom Rubber (ft)",
        panelRepair: "Panel Repair/Brace",
        panelReplace: "Panel Replacement",
      };

      const addPresetPart = (key) => {
        const price = presets.parts[key] ?? 0;
        const label = PRESET_PART_LABELS[key] || key;
        addItem({ name: label, price, qty: 1, unit: 1, taxable: true, group: "Parts" }, { merge: true });
      };

      const estimateNo = useMemo(() => new Date().toISOString().slice(0,10).replaceAll('-', '') + '-' + (customer.phone || 'XXXX').slice(-4), [customer.phone]);

      const handlePrint = () => window.print();

      const [showPartsList, setShowPartsList] = useState(true);

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <span className="inline-flex items-center justify-center w-9 h-9 rounded-2xl bg-sky-500 text-white font-bold">GD</span>
                <div>
                  <div className="font-semibold text-slate-800">Garage Door Estimate</div>
                  <div className="text-xs text-slate-500">Single-page PWA • Offline • Local save</div>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={requestInstall} className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm">Install</button>
                <button onClick={handlePrint} className="px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 text-sm">Print / PDF</button>
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <section className="lg:col-span-1 space-y-4">
              <Card title="Customer">
                <Field label="Name" value={customer.name} onChange={(v) => setCustomer({ ...customer, name: v })} />
                <Field label="Phone" value={customer.phone} onChange={(v) => setCustomer({ ...customer, phone: v })} />
                <Field label="Email" value={customer.email} onChange={(v) => setCustomer({ ...customer, email: v })} />
                <Field label="Address" value={customer.address} onChange={(v) => setCustomer({ ...customer, address: v })} />
                <Field label="City" value={customer.city} onChange={(v) => setCustomer({ ...customer, city: v })} />
                <NumberField label="Coupon/Discount ($)" value={customer.coupon} onChange={(v) => setCustomer({ ...customer, coupon: v })} min={0} step={5} />
                <TextArea label="Notes" value={customer.notes} onChange={(v) => setCustomer({ ...customer, notes: v })} rows={3} />
              </Card>

              <Card title="Settings (Pricing)">
                <NumberField label="Labor Rate $/hr" value={presets.laborRatePerHour} onChange={(v) => setPresets({ ...presets, laborRatePerHour: v })} min={0} step={5} />
                <NumberField label="Min. Hours" value={presets.minLaborHours} onChange={(v) => setPresets({ ...presets, minLaborHours: v })} min={0} step={0.5} />
                <NumberField label="Trip Fee" value={presets.tripFee} onChange={(v) => setPresets({ ...presets, tripFee: v })} min={0} step={1} />
                <NumberField label={`Tax (${pct(presets.taxRate)})`} value={presets.taxRate} onChange={(v) => setPresets({ ...presets, taxRate: v })} min={0} max={0.2} step={0.001} />
                <button
                  className="mt-2 w-full px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm"
                  onClick={() => setShowPartsList((prev) => !prev)}
                >
                  {showPartsList ? "Hide" : "Show"} Parts List
                </button>
                <div className={`mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2 ${showPartsList ? "" : "hidden"}`}>
                  {Object.keys(DEFAULT_PRESETS.parts).map((k) => (
                    <button
                      key={k}
                      className="px-3 py-2 rounded-xl bg-white border border-slate-300 hover:bg-slate-100 text-xs text-left"
                      onClick={() => addPresetPart(k)}
                    >
                      + {PRESET_PART_LABELS[k] || k}
                    </button>
                  ))}
                </div>
              </Card>
              <Card title="Labor">
                <NumberField
                  label="Billable Hours"
                  value={laborHours}
                  onChange={(v) =>
                    setLabor((prev) => ({ ...prev, hours: Number.isFinite(v) && v >= 0 ? v : 0 }))
                  }
                  min={0}
                  step={0.25}
                />
              </Card>
            </section>

            <section className="lg:col-span-2 space-y-4">
              <Card title="Line Items">
                <div className="grid grid-cols-12 gap-2 text-xs font-semibold text-slate-500">
                  <div className="col-span-4">Item</div>
                  <div className="col-span-2">Group</div>
                  <div className="col-span-1 text-right">Qty</div>
                  <div className="col-span-1 text-right">Unit</div>
                  <div className="col-span-2 text-right">Price</div>
                  <div className="col-span-1 text-center">Tax</div>
                  <div className="col-span-1" />
                </div>
                {items.map((it) => (
                  <div key={it.id} className="grid grid-cols-12 gap-2 items-center py-1">
                    <input className="col-span-4 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-sky-300"
                      value={it.name} onChange={(e) => setItems((prev) => prev.map((r) => (r.id === it.id ? { ...r, name: e.target.value } : r)))} />
                    <select className="col-span-2 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none focus:ring-2 focus:ring-sky-300"
                      value={it.group || "Parts"} onChange={(e) => setItems((prev) => prev.map((r) => (r.id === it.id ? { ...r, group: e.target.value } : r)))}>
                      <option>Parts</option>
                      <option>Services</option>
                      <option>Opener</option>
                      <option>Tune-Up</option>
                    </select>
                    <input type="number" className="col-span-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none text-right"
                      value={it.qty} min={0} step={1} onChange={(e) => setItems((prev) => prev.map((r) => (r.id === it.id ? { ...r, qty: Number(e.target.value) } : r)))} />
                    <input type="number" className="col-span-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none text-right"
                      value={it.unit} min={1} step={1} onChange={(e) => setItems((prev) => prev.map((r) => (r.id === it.id ? { ...r, unit: Number(e.target.value) } : r)))} />
                    <input type="number" className="col-span-2 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white outline-none text-right"
                      value={it.price} min={0} step={1} onChange={(e) => setItems((prev) => prev.map((r) => (r.id === it.id ? { ...r, price: Number(e.target.value) } : r)))} />
                    <label className="col-span-1 flex items-center justify-center gap-1 text-sm">
                      <input type="checkbox" checked={it.taxable ?? true} onChange={(e) => setItems((prev) => prev.map((r) => (r.id === it.id ? { ...r, taxable: e.target.checked } : r)))} />
                      <span className="hidden sm:inline">Yes</span>
                    </label>
                    <button className="col-span-1 text-slate-400 hover:text-rose-600" onClick={() => removeItem(it.id)}>✕</button>
                  </div>
                ))}
                <div className="mt-2 flex flex-wrap gap-2">
                  <button className="px-3 py-2 rounded-xl bg-white border border-slate-300 hover:bg-slate-100 text-sm" onClick={() => addItem({ name: "Custom", group: "Parts", price: 0 })}>+ Add Row</button>
                  <button className="px-3 py-2 rounded-xl bg-white border border-slate-300 hover:bg-slate-100 text-sm" onClick={() => setItems([])}>Clear All</button>
                </div>
              </Card>

              <Card title="Totals">
                <div className="grid grid-cols-2 gap-2">
                  <Row label="Parts/Services Subtotal" value={currency(subtotal)} />
                  <Row label={`Labor (${Math.max(laborHours, presets.minLaborHours)} h × ${currency(presets.laborRatePerHour)}/h)`} value={currency(laborCost)} />
                  <Row label={`Tax (${pct(presets.taxRate)})`} value={currency(tax)} />
                  <Row label={"Discount/Coupon"} value={"-" + currency(discount)} />
                  <div className="col-span-2 border-t border-slate-200 mt-2 pt-2" />
                  <Row label={<span className="font-semibold">Total Due</span>} value={<span className="font-bold">{currency(total)}</span>} />
                </div>
              </Card>

              <Card title="Estimate Preview (Print)" className="print-card">
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                  <div className="flex items-start justify-between">
                    <div>
                      <h2 className="text-xl font-semibold">Estimate #{estimateNo}</h2>
                      <div className="text-sm text-slate-500">Garage Door Service WA • (206) 555‑0123 • support@garagedoorservicewa.com</div>
                    </div>
                    <div className="text-right text-sm">
                      <div className="font-medium">{customer.name || "Customer"}</div>
                      <div>{customer.phone}</div>
                      <div>{customer.email}</div>
                      <div>{customer.address}</div>
                      <div>{customer.city}</div>
                    </div>
                  </div>

                  <div className="mt-3 overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left text-slate-500">
                          <th className="py-1">Item</th>
                          <th className="py-1">Group</th>
                          <th className="py-1 text-right">Qty</th>
                          <th className="py-1 text-right">Unit</th>
                          <th className="py-1 text-right">Price</th>
                          <th className="py-1 text-right">Line Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {items.map((it) => (
                          <tr key={it.id} className="border-t border-slate-100">
                            <td className="py-1">{it.name}</td>
                            <td className="py-1">{it.group}</td>
                            <td className="py-1 text-right">{it.qty}</td>
                            <td className="py-1 text-right">{it.unit}</td>
                            <td className="py-1 text-right">{currency(it.price)}</td>
                            <td className="py-1 text-right">{currency(it.qty * it.unit * it.price)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <div className="mt-3 grid grid-cols-2 gap-2 text-sm">
                    <Row label="Parts/Services Subtotal" value={currency(subtotal)} />
                    <Row label={`Labor (${Math.max(laborHours, presets.minLaborHours)} h)`} value={currency(laborCost)} />
                    <Row label={`Tax`} value={currency(tax)} />
                    <Row label={`Discount`} value={"-" + currency(discount)} />
                    <div className="col-span-2 border-t border-slate-200 mt-2 pt-2" />
                    <Row label={<span className="font-semibold">Total</span>} value={<span className="font-bold">{currency(total)}</span>} />
                  </div>

                  <div className="mt-3 text-xs text-slate-500">
                    <p>Notes: {customer.notes || "—"}</p>
                    <p className="mt-1">Warranty: Parts carry manufacturer warranty; workmanship guaranteed 90 days unless otherwise noted. Payment due on completion. Card payments +3% fee. Prices subject to WA sales tax.</p>
                  </div>
                </div>
              </Card>

              <div className="flex gap-2">
                <button className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm" onClick={() => requestInstall()}>Install</button>
                <button className="px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 text-sm" onClick={() => window.print()}>Print / PDF</button>
              </div>
            </section>
          </main>

          <footer className="max-w-6xl mx-auto p-4 text-center text-xs text-slate-500">
            Built as a demo. Edit presets to match your pricing. Your data stays in your browser.
          </footer>

          <style>{`
            @media print {
              *, *::before, *::after { box-shadow: none !important; }
              body { margin: 0; background: #fff !important; }
              body * { visibility: hidden; }
              .print-card, .print-card * { visibility: visible; }
              .print-card {
                position: absolute;
                inset: 0;
                margin: 0;
                border: none !important;
                width: 100%;
                max-width: 100%;
                padding: 1.5rem;
              }
              header, footer { display: none !important; }
            }
          `}</style>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
